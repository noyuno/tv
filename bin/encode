#!/bin/bash -ex

src=/mnt/hddsg3-plain0/tv/ts
dst=/mnt/hddsg3-plain0/tv/mp4/2021/00_アニメ
enc=/home/noyuno/tv/EPGStation/enc.sh

find "$src" -name '*.ts' | while read line ; do
    FFMPEG=ffmpeg \
    INPUT=$line \
    OUTPUT=$(echo "$line" | sed 's|'"$src"'|'"$dst"'|' | sed 's|.ts$|.mp4|') \
    $enc 1080p
    if [ -f "$OUTPUT" ]; then
        if [ $(stat -c %s "$OUTPUT") -gt 10000 ]; then
            rm -f "$INPUT"
        else
            echo "encode error: < 10000 bytes"
            exit 1
        fi
    else
        echo "encode error"
        exit 1
    fi
done
