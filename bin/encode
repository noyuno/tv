#!/bin/bash -ex

src=/mnt/hddsg3-plain0/tv/ts
dst=/mnt/hddsg3-plain0/tv/mp4/2021/00_アニメ
enc=/home/noyuno/tv/EPGStation/enc.sh

find "$src" -name '*.ts' -type f | while read input ; do
    out=$(echo "$input" | sed 's|'"$src"'|'"$dst"'|' | sed 's|.ts$|.mp4|')
    FFMPEG=ffmpeg \
    INPUT=$input \
    OUTPUT=$out \
    $enc 1080p
    if [ -f "$out" ]; then
        if [ $(stat -c %s "$out") -gt 10000 ]; then
            rm -f "$input"
        else
            echo "encode error: < 10000 bytes"
            exit 1
        fi
    else
        echo "encode error"
        exit 1
    fi
done
